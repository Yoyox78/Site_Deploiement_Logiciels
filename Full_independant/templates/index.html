<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Installation de logiciels</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}" type="text/css" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/blog.css') }}" type="text/css" />
    <script src="{{ url_for('static', filename='js/jquery.min.js') }}"></script>
    <style>
      /* Pour la réponse */
      .response { 
        font-size: 18px; 
        margin: 5px 0;
      }
      /* Le conteneur prend toute la largeur */
      .container {
        display: flex; 
        justify-content: space-between; 
        align-items: center;
        width: 100%;
        padding: 5px;
        box-sizing: border-box;
      }
      /* Le titre prend toute la largeur restante (pour forcer le push) */
      .container h2 {
        margin: 0;
        flex: 1;
      }
      /* Le groupe de boutons est aligné à droite */
      .btn-group {
        display: flex;
        align-items: center;
      }
      button {
        padding: 5px 10px;
        cursor: pointer;
        margin-left: 5px;
      }
      /* Spinner individuel supprimé, on utilisera spinner global */

      /* Spinner global overlay */
      #overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0,0,0,0.4);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }
      #overlay .spinner {
        width: 48px;
        height: 48px;
        border: 5px solid rgba(255, 255, 255, 0.3);
        border-top-color: #fff;
        border-radius: 50%;
        animation: spin 0.6s linear infinite;
      }
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      .hidden { display: none; }
      /* Pour éviter d'avoir un padding par défaut sur le td */
      td { padding: 0; }
    </style>
  </head>
  <body>
    <div id="divbodyholder">
      <div class="headerholder">
        <div class="header">
          <div id="title">
            <h1 class="nomargin"><a class="ablack" href="#">Installation de logiciels</a></h1>
            <div id="description">Déploiement de logiciels</div>
          </div>
        </div>
      </div>
      <div id="divbody">
        <div class="content">
          <div class="wrapper">
            <script src="{{ url_for('static', filename='js/chart.js') }}"></script>
            <!-- Structure en tableau pour afficher les logiciels -->
            <table style="width: 100%;">
              <tbody>
                {% for i in range(0, len) %}
                <tr>
                  <td>
                    <div id="{{logiciels[i]}}" class="container">
                      <h2>{{logiciels[i]}}</h2>
                      <div class="btn-group">
                        <button id="bt-{{logiciels[i]}}"
                          onclick="installSoftware('{{logiciels[i]}}')">
                          Installer/MAJ
                        </button>
                        <button id="btrm-{{logiciels[i]}}"
                          onclick="removeSoftware('{{logiciels[i]}}')">
                          Supprimer
                        </button>
                        <!-- Plus de spinner individuel -->
                      </div>
                    </div>
                    <div class="response" id="response-{{logiciels[i]}}"></div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Overlay global avec spinner -->
    <div id="overlay">
      <div class="spinner"></div>
    </div>

    <script>
      // Afficher ou cacher overlay global
      function toggleOverlay(show) {
        var overlay = document.getElementById('overlay');
        if (show) {
          overlay.style.display = 'flex';
        } else {
          overlay.style.display = 'none';
        }
      }

      // Activer/Désactiver tous les boutons pour éviter double clic
      function toggleAllButtons(disable) {
        var buttons = document.querySelectorAll('button');
        buttons.forEach(function(btn) {
          btn.disabled = disable;
        });
      }

      function installSoftware(logiciel) {
        toggleOverlay(true);
        toggleAllButtons(true);

        var xhr = new XMLHttpRequest();
        xhr.open("GET", "/deploy?logiciel=" + encodeURIComponent(logiciel), true);
        xhr.onload = function() {
          toggleOverlay(false);
          toggleAllButtons(false);

          if (xhr.status === 200) {
            var response = JSON.parse(xhr.responseText);
            var status   = JSON.stringify(response.status);
            var stdout   = JSON.stringify(response.stdout);
            var combi    = status + stdout;
            var stdoutbr = combi.replace(/(\\n)/gm, '<br>');
            var regex    = /success/;
            var respDiv = document.getElementById('response-' + logiciel);
            if (regex.test(status)) { 
              respDiv.style.backgroundColor = 'green';
              respDiv.textContent = 'Installation réussie';
            } else {
              respDiv.style.backgroundColor = 'red';
              respDiv.innerHTML = stdoutbr.replace(/"failure"/, 'Erreur lors de l\'installation <br>');
            }
          } else {
            alert("Erreur lors de l'installation : " + xhr.status);
          }
        };
        xhr.send();
      }
      
      function removeSoftware(logiciel) {
        toggleOverlay(true);
        toggleAllButtons(true);

        var xhr = new XMLHttpRequest();
        xhr.open("GET", "/remove?logiciel=" + encodeURIComponent(logiciel), true);
        xhr.onload = function() {
          toggleOverlay(false);
          toggleAllButtons(false);

          if (xhr.status === 200) {
            var response = JSON.parse(xhr.responseText);
            var status   = JSON.stringify(response.status);
            var stdout   = JSON.stringify(response.stdout);
            var combi    = status + stdout;
            var stdoutbr = combi.replace(/(\\n)/gm, '<br>');
            var regex    = /success/;
            var respDiv = document.getElementById('response-' + logiciel);
            if (regex.test(status)) { 
              respDiv.style.backgroundColor = 'green';
              respDiv.textContent = 'Désinstallation réussie';
            } else {
              respDiv.style.backgroundColor = 'red';
              respDiv.innerHTML = stdoutbr.replace(/"failure"/, 'Erreur lors de la désinstallation <br>');
            }
          } else {
            alert("Erreur lors de la désinstallation : " + xhr.status);
          }
        };
        xhr.send();
      }
    </script>
  </body>
</html>
